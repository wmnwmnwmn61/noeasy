<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>新闻营销号</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#4ade80',
                        secondary: '#22c55e',
                        accent: '#16a34a',
                        light: '#dcfce7',
                        dark: '#059669',
                    },
                    fontFamily: {
                        sans: ['Inter', 'system-ui', 'sans-serif'],
                    },
                }
            }
        }
    </script>
    <style type="text/tailwindcss">
        @layer utilities {
            .content-auto {
                content-visibility: auto;
            }
            .bg-blur {
                backdrop-filter: blur(8px);
            }
            .text-shadow {
                text-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            }
            .transition-custom {
                transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            }
        }
    </style>
</head>

<body class="bg-gradient-to-br from-light to-primary/30 min-h-screen font-sans">
    <!-- 加载背景图片的占位符 -->
    <div id="background-container" class="fixed inset-0 z-0 opacity-10"></div>

    <div class="relative z-10 max-w-6xl mx-auto px-4 py-8">
        <!-- 头部 -->
        <header class="mb-10 text-center">
            <div class="inline-block relative">
                <h1
                    class="text-[clamp(2rem,5vw,3.5rem)] font-bold text-dark mb-2 text-shadow transform transition-custom hover:scale-105">
                    <i class="fa fa-newspaper-o mr-3 text-accent"></i>新闻营销号
                </h1>
                <div class="h-1 w-full bg-gradient-to-r from-accent to-transparent rounded-full mt-2"></div>
            </div>
            <p class="text-gray-700 mt-4 text-lg max-w-2xl mx-auto">
                输入新闻内容，一键转换成吸引人的营销号风格，并自动生成相关图片
            </p>
        </header>

        <!-- 主要内容区 -->
        <main class="grid grid-cols-1 lg:grid-cols-2 gap-8">
            <!-- 输入区域 -->
            <section class="bg-white/80 bg-blur rounded-2xl shadow-lg p-6 transition-custom hover:shadow-xl">
                <h2 class="text-2xl font-semibold text-dark mb-4 flex items-center">
                    <i class="fa fa-pencil-square-o mr-2 text-secondary"></i>输入新闻内容
                </h2>

                <div class="space-y-4">
                    <div>
                        <label for="news-title" class="block text-gray-700 mb-1 font-medium">新闻标题</label>
                        <input type="text" id="news-title"
                            class="w-full px-4 py-3 rounded-lg border border-primary/30 focus:ring-2 focus:ring-primary/50 focus:border-primary outline-none transition-custom"
                            placeholder="输入新闻标题...">
                    </div>

                    <div>
                        <label for="news-content" class="block text-gray-700 mb-1 font-medium">新闻内容</label>
                        <textarea id="news-content" rows="10"
                            class="w-full px-4 py-3 rounded-lg border border-primary/30 focus:ring-2 focus:ring-primary/50 focus:border-primary outline-none transition-custom"
                            placeholder="输入新闻详细内容..."></textarea>
                    </div>

                    <div>
                        <label for="marketing-style" class="block text-gray-700 mb-1 font-medium">营销号风格</label>
                        <select id="marketing-style"
                            class="w-full px-4 py-3 rounded-lg border border-primary/30 focus:ring-2 focus:ring-primary/50 focus:border-primary outline-none transition-custom bg-white">
                            <option value="sensational">震惊体</option>
                            <option value="emotional">情感共鸣</option>
                            <option value="mysterious">悬疑揭秘</option>
                            <option value="inspirational">励志正能量</option>
                            <option value="warning">警示提醒</option>
                        </select>
                    </div>

                    <div class="pt-2">
                        <button id="convert-btn"
                            class="w-full bg-gradient-to-r from-primary to-accent text-white font-bold py-3 px-6 rounded-lg shadow-md hover:shadow-lg transition-custom transform hover:-translate-y-1 focus:outline-none focus:ring-2 focus:ring-primary/50 flex items-center justify-center">
                            <i class="fa fa-magic mr-2"></i>转换并生成图片
                        </button>
                    </div>
                </div>
            </section>

            <!-- 输出区域 -->
            <section class="bg-white/80 bg-blur rounded-2xl shadow-lg p-6 transition-custom hover:shadow-xl">
                <h2 class="text-2xl font-semibold text-dark mb-4 flex items-center">
                    <i class="fa fa-bullhorn mr-2 text-secondary"></i>营销号文章
                </h2>

                <div id="output-container" class="space-y-6">
                    <div class="hidden" id="loading-indicator">
                        <div class="flex justify-center items-center py-10">
                            <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-primary"></div>
                            <p class="ml-4 text-gray-700">正在生成营销号文章和图片...</p>
                        </div>
                    </div>

                    <div id="output-content" class="space-y-4">
                        <h3 id="marketing-title" class="text-xl font-bold text-dark text-shadow"></h3>
                        <div id="marketing-article" class="prose max-w-none text-gray-800"></div>

                        <div id="image-container" class="mt-6">
                            <img id="generated-image" src="" alt="生成的图片"
                                class="w-full h-auto rounded-lg shadow-md hidden transition-custom hover:shadow-lg transform hover:scale-[1.02]">
                        </div>
                    </div>
                </div>
            </section>
        </main>

        <!-- 历史记录区域 -->
        <section class="mt-12 bg-white/80 bg-blur rounded-2xl shadow-lg p-6 transition-custom hover:shadow-xl">
            <h2 class="text-2xl font-semibold text-dark mb-4 flex items-center">
                <i class="fa fa-history mr-2 text-secondary"></i>生成历史
            </h2>

            <div id="history-container" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4">
                <!-- 历史记录将在这里动态添加 -->
                <div class="text-gray-500 text-center py-6" id="empty-history">
                    <i class="fa fa-folder-open-o text-4xl mb-2"></i>
                    <p>暂无生成历史</p>
                </div>
            </div>
        </section>
    </div>

    <!-- 页脚 -->
    <footer class="relative z-10 mt-12 py-6 border-t border-primary/20">
        <div class="max-w-6xl mx-auto px-4 text-center text-gray-600">
            <p>&copy; 2023 新闻营销号 | 一键生成吸引人的营销内容</p>
            <div class="mt-2 flex justify-center space-x-4">
                <a href="#" class="text-dark hover:text-accent transition-custom"><i class="fa fa-github"></i></a>
                <a href="#" class="text-dark hover:text-accent transition-custom"><i class="fa fa-twitter"></i></a>
                <a href="#" class="text-dark hover:text-accent transition-custom"><i class="fa fa-linkedin"></i></a>
            </div>
        </div>
    </footer>

    <script>
        // 应用配置 - 可通过环境变量或URL参数覆盖
        const appConfig = {
            // API基础路径，默认为空字符串（相对路径）
            apiBaseUrl: '',
            // 重试配置
            retry: {
                maxAttempts: 3,
                delay: 1000
            }
        };

        // 从URL参数加载配置
        function loadConfigFromUrl() {
            const urlParams = new URLSearchParams(window.location.search);
            if (urlParams.has('apiBaseUrl')) {
                appConfig.apiBaseUrl = urlParams.get('apiBaseUrl').replace(/\/$/, '');
            }
        }

        // 初始化配置
        loadConfigFromUrl();

        // 生成完整的API URL
        function getApiUrl(endpoint) {
            return appConfig.apiBaseUrl + endpoint;
        }

        // 带重试逻辑的fetch函数
        async function fetchWithRetry(url, options = {}, attempt = 0) {
            try {
                const response = await fetch(url, options);
                if (!response.ok) {
                    throw new Error(`HTTP错误! 状态码: ${response.status}`);
                }
                return response;
            } catch (error) {
                // 如果是网络错误且还有重试次数，进行重试
                if (attempt < appConfig.retry.maxAttempts && 
                    (error.name === 'TypeError' || error.message.includes('Failed to fetch'))) {
                    console.warn(`请求失败，${appConfig.retry.delay}ms后重试 (${attempt + 1}/${appConfig.retry.maxAttempts})...`);
                    await new Promise(resolve => setTimeout(resolve, appConfig.retry.delay));
                    return fetchWithRetry(url, options, attempt + 1);
                }
                throw error;
            }
        }

        // 生成背景图片
        function generateBackgroundImage() {
            // 调用后端API获取生成的背景图片
            const backgroundContainer = document.getElementById('background-container');

            fetchWithRetry(getApiUrl('/background_image'))
                .then(response => {
                    // 创建图片URL
                    const imageUrl = response.url;
                    backgroundContainer.style.backgroundImage = `url('${imageUrl}')`;
                    backgroundContainer.style.backgroundSize = 'cover';
                    backgroundContainer.style.backgroundPosition = 'center';
                })
                .catch(error => {
                    console.error('生成背景图片时出错:', error);
                    // 出错时使用备用图片
                    const bgImages = [
                        'https://picsum.photos/id/1000/1920/1080',
                        'https://picsum.photos/id/1002/1920/1080',
                        'https://picsum.photos/id/1003/1920/1080',
                        'https://picsum.photos/id/1004/1920/1080',
                        'https://picsum.photos/id/1006/1920/1080'
                    ];

                    const randomBg = bgImages[Math.floor(Math.random() * bgImages.length)];
                    backgroundContainer.style.backgroundImage = `url('${randomBg}')`;
                    backgroundContainer.style.backgroundSize = 'cover';
                    backgroundContainer.style.backgroundPosition = 'center';
                });
        }

        // 页面加载时生成背景图片
        window.addEventListener('load', generateBackgroundImage);

        // 转换按钮点击事件
        document.getElementById('convert-btn').addEventListener('click', async function () {
            const newsTitle = document.getElementById('news-title').value.trim();
            const newsContent = document.getElementById('news-content').value.trim();
            const marketingStyle = document.getElementById('marketing-style').value;

            if (!newsTitle || !newsContent) {
                alert('请输入新闻标题和内容');
                return;
            }

            // 显示加载指示器
            document.getElementById('loading-indicator').classList.remove('hidden');
            document.getElementById('output-content').classList.add('hidden');

            // 调用后端API进行转换
            fetchWithRetry(getApiUrl('/convert'), {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    title: newsTitle,
                    content: newsContent,
                    style: marketingStyle
                })
            })
                .then(response => {
                    if (!response.ok) {
                        throw new Error('转换失败，请稍后重试');
                    }
                    return response.json();
                })
                .then(data => {
                    // 更新输出区域
                    document.getElementById('marketing-title').textContent = data.title;
                    document.getElementById('marketing-article').textContent = data.content;

                    // 更新图片
                    const generatedImage = document.getElementById('generated-image');
                    if (data.image_url) {
                        generatedImage.src = data.image_url;
                        generatedImage.classList.remove('hidden');
                    } else {
                        generatedImage.classList.add('hidden');
                    }

                    // 添加到历史记录
                    addToHistory(data.title, data.content, data.image_url);

                    // 隐藏加载指示器
                    document.getElementById('loading-indicator').classList.add('hidden');
                    document.getElementById('output-content').classList.remove('hidden');
                })
                .catch(error => {
                    console.error('转换过程中出错:', error);

                    // 首先确保隐藏加载指示器
                    document.getElementById('loading-indicator').classList.add('hidden');
                    document.getElementById('output-content').classList.remove('hidden');

                    // 获取更详细的错误信息
                    let errorMessage = '转换失败，请稍后重试';

                    // 检查错误类型，处理不同的错误情况
                    if (error instanceof TypeError && error.message.includes('Failed to fetch')) {
                        errorMessage = '网络连接失败，请检查您的网络设置';
                        alert(errorMessage);
                    } else if (error.response) {
                        // 这是Fetch API的Response对象
                        if (error.response.status === 404) {
                            errorMessage = '请求的资源不存在';
                        } else if (error.response.status === 500) {
                            errorMessage = '服务器内部错误，请稍后再试';
                        }

                        // 尝试获取JSON格式的错误信息
                        if (error.response.json) {
                            error.response.json().then(jsonError => {
                                if (jsonError.error) {
                                    alert('错误: ' + jsonError.error);
                                } else {
                                    alert(errorMessage);
                                }
                            }).catch(() => {
                                alert(errorMessage);
                            });
                        } else {
                            // 如果无法获取JSON响应，直接显示错误信息
                            alert(errorMessage);
                        }
                    } else if (error.message) {
                        // 其他类型的JavaScript错误
                        errorMessage = '转换过程中出错: ' + error.message;
                        alert(errorMessage);
                    } else {
                        // 默认错误处理
                        alert(errorMessage);
                    }
                });
        });

        // 添加到历史记录
        function addToHistory(title, content, imageUrl) {
            const historyContainer = document.getElementById('history-container');
            const emptyHistory = document.getElementById('empty-history');

            // 隐藏空历史提示
            emptyHistory.classList.add('hidden');

            // 创建历史记录卡片
            const historyCard = document.createElement('div');
            historyCard.className = 'bg-white rounded-xl shadow-md p-4 transition-custom hover:shadow-lg transform hover:-translate-y-1';

            // 存储数据以便稍后查看
            historyCard.dataset.title = title;
            historyCard.dataset.content = content;
            historyCard.dataset.imageUrl = imageUrl || '';

            let imageHtml = '';
            if (imageUrl) {
                imageHtml = `<div class="mb-2 h-16 overflow-hidden rounded-lg"><img src="${imageUrl}" alt="相关图片" class="w-full h-full object-cover"></div>`;
            }

            historyCard.innerHTML = `
                ${imageHtml}
                <h4 class="font-bold text-dark text-sm mb-2 line-clamp-2">${title}</h4>
                <p class="text-gray-600 text-xs mb-3 line-clamp-3">${content}</p>
                <button class="text-xs text-primary hover:text-accent transition-custom">
                    <i class="fa fa-eye mr-1"></i>查看详情
                </button>
            `;

            // 添加点击事件
            historyCard.querySelector('button').addEventListener('click', function () {
                document.getElementById('marketing-title').textContent = historyCard.dataset.title;
                document.getElementById('marketing-article').textContent = historyCard.dataset.content;

                const generatedImage = document.getElementById('generated-image');
                if (historyCard.dataset.imageUrl) {
                    generatedImage.src = historyCard.dataset.imageUrl;
                    generatedImage.classList.remove('hidden');
                } else {
                    generatedImage.classList.add('hidden');
                }
            });

            // 添加到容器前面
            historyContainer.insertBefore(historyCard, historyContainer.firstChild);

            // 限制历史记录数量为10条
            const historyItems = historyContainer.querySelectorAll('div[class*="bg-white"]');
            if (historyItems.length > 10) {
                historyContainer.removeChild(historyItems[historyItems.length - 1]);
            }
        }
    </script>
</body>

</html>
